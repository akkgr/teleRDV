"use strict";angular.module("app",["ngRoute","angular-loading-bar","treeControl","pascalprecht.translate","tmh.dynamicLocale","LocalStorageModule","ngSanitize","ui.checkbox","ui.bootstrap","ui.bootstrap.datetimepicker"]),angular.module("app").constant("baseUrl","/"),angular.module("app").constant("ngAuthSettings",{apiServiceBaseUri:"/",clientId:"cinnamon"}),angular.module("app").config(["$routeProvider",function(e){e.when("/login",{controller:"loginController",templateUrl:"views/login.html"}).when("/",{templateUrl:"views/main.html"}).when("/subscribers",{templateUrl:"views/subscribers.html",controller:"SubscribersCtrl"}).when("/subscribers/:id",{templateUrl:"views/subscriber.html",controller:"SubscriberCtrl"}).when("/specialties",{templateUrl:"views/specialties.html",controller:"SpecialtiesCtrl"}).when("/specialties/:id",{templateUrl:"views/specialty.html",controller:"SpecialtyCtrl"}).when("/calendar",{templateUrl:"views/calendar.html",controller:"CalendarCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/users/:id",{templateUrl:"views/user.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("app").config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]),angular.module("app").config(["tmhDynamicLocaleProvider",function(e){e.localeLocationPattern("scripts/angular-locale_{{locale}}.js")}]),angular.module("app").run([function(){toastr.options.positionClass="toast-bottom-center",toastr.options.closeButton=!0,toastr.options.timeOut=0,toastr.options.extendedTimeOut=0}]),angular.module("app").config(["$httpProvider",function(e){e.interceptors.push("authInterceptorService")}]),angular.module("app").run(["authService",function(e){e.fillAuthData()}]),angular.module("app").config(["localStorageServiceProvider",function(e){e.setStorageType("sessionStorage")}]),angular.module("app").config(["$translateProvider",function(e){e.translations("en",{Subscribers:"Doctors",Subscriber:"Doctor",Specialties:"Specialties",SubscribersList:"Doctors List",LogIn:"Log In",ChangePassword:"Change Password",UsersManagment:"Users Managment",LogOut:"Log Out",LastName:"Last Name",FirstName:"First Name",Company:"Company",Info:"Profile",Phones:"Phones",Addresses:"Addresses",OtherInfo:"Social",DivertPhones:"Diverted Phones",Area:"Area",Street:"Street",PostalCode:"Postal Code",Number:"Number",Type:"Type",Home:"Home",Work:"Work",Mobile:"Mobile",Fax:"Fax",Floor:"Floor",CallAnswer:"Call Answer",Directions:"Directions",Specialty:"Specialty",Title:"Title"}),e.translations("el",{Subscribers:"Ιατροί",Subscriber:"Ιατρός",Specialties:"Ειδικότητες",SubscribersList:"Αρχείο Ιατρών",LogIn:"Σύνδεση",ChangePassword:"Αλλαγή Κωδικού",UsersManagment:"Διαχείρηση Χρηστών",LogOut:"Αποσύνδεση",LastName:"Επώνυμο",FirstName:"Όνομα",Company:"Εταιρεία",Info:"Στοιχεία",Phones:"Τηλέφωνα",Addresses:"Διευθύνσεις",OtherInfo:"Άλλα Στοιχεία",DivertPhones:"Τηλ. Εκτροπής",Area:"Περιοχή",Street:"Οδός",PostalCode:"ΤΚ",Number:"Αριθμός",Type:"Είδος",Home:"Οικίας",Work:"Εργασίας",Mobile:"Κινητό",Fax:"Φαξ",Floor:"Όροφος",CallAnswer:"Τρόπος Απάντησης",Directions:"Πρόσβαση",Specialty:"Ειδικότητα",Title:"Περιγραφή"}),e.preferredLanguage("el"),e.useSanitizeValueStrategy(null)}]),angular.module("app").controller("CalendarCtrl",["$scope","$http","$location","baseUrl",function(e,t,r,s){e.getData=function(){t({method:"GET",url:s+"api/subscribers"}).then(function(t){e.subscribers=t.data},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.selectRow=function(t){e.selectedSubscriber=t},e.add=function(){r.path("/subscribers/new")},e.edit=function(){e.selectedSubscriber&&r.path("/subscribers/"+e.selectedSubscriber.Id)},e.getSpecialties=function(){t({method:"GET",url:s+"api/specialties/"}).then(function(t){e.specialties=t.data,$(".selectpicker").selectpicker("refresh")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.getSpecialties(),e.getData()}]),angular.module("app").controller("loginController",["$scope","$location","authService","ngAuthSettings",function(e,t,r,s){e.loginData={userName:"",password:"",useRefreshTokens:!1},e.message="",e.login=function(){r.login(e.loginData).then(function(){t.path("/")},function(t){e.message=t.error_description})},e.authExternalProvider=function(t){var r=location.protocol+"//"+location.host+"/authcomplete.html",a=s.apiServiceBaseUri+"api/Account/ExternalLogin?provider="+t+"&response_type=token&client_id="+s.clientId+"&redirect_uri="+r;window.$windowScope=e,window.open(a,"Authenticate Account","location=0,status=0,width=600,height=750")},e.authCompletedCB=function(s){e.$apply(function(){if("False"==s.haslocalaccount)r.logOut(),r.externalAuthData={provider:s.provider,userName:s.external_user_name,externalAccessToken:s.external_access_token},t.path("/associate");else{var a={provider:s.provider,externalAccessToken:s.external_access_token};r.obtainAccessToken(a).then(function(){t.path("/orders")},function(t){e.message=t.error_description})}})}}]),angular.module("app").controller("NavCtrl",["$scope","$translate","authService","$location","localStorageService","tmhDynamicLocale","localeService","$http","baseUrl","$window",function(e,t,r,s,a,n,o,i,u,c){r.fillAuthData(),e.authentication=r.authentication,e.language=o.language,e.changeLanguage=function(e){o.setLocale(e),document.documentElement.setAttribute("lang",e)},e.logOut=function(){r.logOut(),s.path("/")},e.login=function(){r.logOut(),s.path("/login")},e.changePassword=function(){i({method:"PUT",url:u+"api/admin",data:e.user}).then(function(){swal("Success","Password successfully changed.","success"),$("#changeMyPassword").modal("hide")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.print=function(){i.get(u+"api/reports/requests/2000/1/1/2016/12/31/0",{responseType:"arraybuffer"}).success(function(e){var t=new Blob([e],{type:"application/pdf"}),r=URL.createObjectURL(t);c.open(r)}).error(function(e){var t=document.getElementById("pdf");t.data=null,e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})}}]),angular.module("app").controller("SpecialtiesCtrl",["$scope","$http","$location","baseUrl",function(e,t,r,s){e.getData=function(){t({method:"GET",url:s+"api/specialties"}).then(function(t){e.specialties=t.data},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.selectRow=function(t){e.selectedSpecialty=t},e.add=function(){r.path("/specialties/new")},e.edit=function(){e.selectedSpecialty&&r.path("/specialties/"+e.selectedSpecialty.Id)},e.getData()}]),angular.module("app").controller("SpecialtyCtrl",["$scope","$http","$routeParams","baseUrl","enumService","$location",function(e,t,r,s,a,n){e.getData=function(){"new"===r.id?e.specialty={}:t({method:"GET",url:s+"api/specialties/"+r.id}).then(function(t){e.specialty=t.data,$(".selectpicker").selectpicker("refresh")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.save=function(){var r="POST",a=s+"api/specialties";e.specialty.Id&&(r="PUT",a=s+"api/specialties/"+e.specialty.Id),t({method:r,url:a,data:e.specialty}).then(function(t){e.specialty=t.data,swal("Success","Contact successfully saved.","success"),n.path("/specialties")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.delete=function(){e.specialty.Id&&swal({title:"Are you sure?",text:"Are you sure that you want to delete this contact?",type:"warning",showCancelButton:!0,closeOnConfirm:!1,confirmButtonText:"Yes, delete it!",confirmButtonColor:"#ec6c62"},function(){t({method:"DELETE",url:s+"api/people/"+e.specialty.Id}).then(function(){swal("Success","Contact successfully deleted.","success"),n.path("/contacts")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})})},e.getData()}]),angular.module("app").controller("SubscriberCtrl",["$scope","$http","$routeParams","baseUrl","enumService","$location",function(e,t,r,s,a,n){a.PhoneTypes().then(function(t){e.phoneTypes=t.data}),a.AddressTypes().then(function(t){e.addressTypes=t.data}),a.InfoTypes().then(function(t){e.infoTypes=t.data}),e.getData=function(){"new"===r.id?e.subscriber={Phones:[],Addresses:[],Infos:[],DivertPhones:[],PaymentMethods:[],SocialSecurityFunds:[]}:t({method:"GET",url:s+"api/subscribers/"+r.id}).then(function(t){e.subscriber=t.data,$(".selectpicker").selectpicker("val",e.subscriber.Specialty.Id)},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.save=function(){var r="POST",a=s+"api/subscribers";e.subscriber.Id&&(r="PUT",a=s+"api/subscribers/"+e.subscriber.Id),t({method:r,url:a,data:e.subscriber}).then(function(t){e.subscriber=t.data,swal("Success","Contact successfully saved.","success"),n.path("/subscribers")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.delete=function(){e.subscriber.Id&&swal({title:"Are you sure?",text:"Are you sure that you want to delete this contact?",type:"warning",showCancelButton:!0,closeOnConfirm:!1,confirmButtonText:"Yes, delete it!",confirmButtonColor:"#ec6c62"},function(){t({method:"DELETE",url:s+"api/people/"+e.subscriber.Id}).then(function(){swal("Success","Contact successfully deleted.","success"),n.path("/contacts")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})})},e.addAddress=function(){e.subscriber.Addresses.push({})},e.deleteAddress=function(t){var r=e.subscriber.Addresses.indexOf(t,0);r>-1&&e.subscriber.Addresses.splice(r,1)},e.addPhone=function(){e.subscriber.Phones.push({})},e.deletePhone=function(t){var r=e.subscriber.Phones.indexOf(t,0);r>-1&&e.subscriber.Phones.splice(r,1)},e.addInfo=function(){e.subscriber.Infos.push({})},e.deleteInfo=function(t){var r=e.subscriber.Infos.indexOf(t,0);r>-1&&e.subscriber.Infos.splice(r,1)},e.addDivertPhone=function(){e.subscriber.DivertPhones.push({})},e.deleteDivertPhone=function(t){var r=e.subscriber.DivertPhones.indexOf(t,0);r>-1&&e.subscriber.DivertPhones.splice(r,1)},e.getSpecialties=function(){t({method:"GET",url:s+"api/specialties/"}).then(function(t){e.specialties=t.data,e.getData()},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.getSpecialties()}]),angular.module("app").controller("SubscribersCtrl",["$scope","$http","$location","baseUrl",function(e,t,r,s){e.getData=function(){t({method:"GET",url:s+"api/subscribers"}).then(function(t){e.subscribers=t.data},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.selectRow=function(t){e.selectedSubscriber=t},e.add=function(){r.path("/subscribers/new")},e.edit=function(){e.selectedSubscriber&&r.path("/subscribers/"+e.selectedSubscriber.Id)},e.getSpecialties=function(){t({method:"GET",url:s+"api/specialties/"}).then(function(t){e.specialties=t.data,$(".selectpicker").selectpicker("refresh")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.getSpecialties(),e.getData()}]),angular.module("app").controller("UserCtrl",["$scope","$http","$routeParams","baseUrl","$location",function(e,t,r,s,a){e.getRoles=function(){t({method:"GET",url:s+"api/roles/"}).then(function(t){e.roles=t.data,$(".selectpicker").selectpicker("refresh")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.getData=function(){"new"===r.id?(e.isNew=!0,e.user={Roles:[]},e.getRoles()):(e.isNew=!1,t({method:"GET",url:s+"api/users/"+r.id}).then(function(t){e.user=t.data,e.getRoles(),$(".selectpicker").selectpicker("refresh")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")}))},e.save=function(){var r="POST",n=s+"api/users";e.user.Id&&(r="PUT",n=s+"api/users/"+e.user.Id),t({method:r,url:n,data:e.user}).then(function(t){e.user=t.data,swal("Success","Contact successfully saved.","success"),a.path("/users")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.delete=function(){e.user.Id&&swal({title:"Are you sure?",text:"Are you sure that you want to delete this contact?",type:"warning",showCancelButton:!0,closeOnConfirm:!1,confirmButtonText:"Yes, delete it!",confirmButtonColor:"#ec6c62"},function(){t({method:"DELETE",url:s+"api/users/"+e.user.Id}).then(function(){swal("Success","Contact successfully deleted.","success"),a.path("/users")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})})},e.changePassword=function(){t({method:"POST",url:s+"api/admin",data:e.user}).then(function(){swal("Success","Password successfully changed.","success"),$("#changeUserPassword").modal("hide")},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.getRoles(),e.getData()}]),angular.module("app").controller("UsersCtrl",["$scope","$http","$location","baseUrl",function(e,t,r,s){e.getData=function(){t({method:"GET",url:s+"api/users"}).then(function(t){e.users=t.data},function(e){e.status===-1?swal("Error","Server unavailable!","error"):swal("Error",e.statusText+". "+e.data.Message,"error")})},e.selectRow=function(t){e.selectedUser=t},e.add=function(){r.path("/users/new")},e.edit=function(){e.selectedUser&&r.path("/users/"+e.selectedUser.Id)},e.getData()}]),angular.module("app").directive("convertToNumber",function(){return{require:"ngModel",link:function(e,t,r,s){s.$parsers.push(function(e){return parseInt(e,10)}),s.$formatters.push(function(e){return""+e})}}}),angular.module("app").directive("formHeader",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{delete:"&",save:"&"},templateUrl:"/views/form-header.html",link:function(){$(function(){$('[data-toggle="tooltip"]').tooltip()})}}}),angular.module("app").directive("listHeader",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{search:"=",add:"&",edit:"&",save:"&",filter:"&"},templateUrl:"/views/list-header.html",link:function(){$(function(){$('[data-toggle="tooltip"]').tooltip()})}}}),angular.module("app").directive("myDateInput",["localeService",function(e){return{restrict:"E",scope:{dateTime:"="},template:'<div class="input-group"><input type="text" class="form-control" datetime-picker="{{language.dateFormat}}" datepicker-options="popup.options" ng-model="dateTime" is-open="popup.opened"><span class="input-group-btn"><button type="button" class="btn btn-default" ng-click="open()"><i class="glyphicon glyphicon-calendar"></i></button></span></div>',link:function(t){t.open=function(){t.popup.opened=!0},t.popup={opened:!1,options:{showWeeks:!1}},t.language=e.language}}}]),angular.module("app").directive("onFinishRender",["$timeout",function(e){return{restrict:"A",link:function(t){t.$last===!0&&e(function(){t.$emit("ngRepeatFinished")})}}}]),angular.module("app").directive("selectPicker",["$timeout",function(e){return{restrict:"A",scope:!1,link:function(t,r){e(function(){var e=$(r);e.selectpicker("refresh")})}}}]),angular.module("app").directive("stringToDate",function(){return{require:"ngModel",link:function(e,t,r,s){s.$formatters.push(function(e){if(!e)return null;var t=new Date(e);return t})}}}),angular.module("app").factory("authInterceptorService",["$q","$injector","$location","localStorageService",function(e,t,r,s){var a={},n=function(e){e.headers=e.headers||{};var t=s.get("authorizationData");t&&(e.headers.Authorization="Bearer "+t.token);var r=s.get("language");return r&&(e.headers["Accept-Language"]=r),e},o=function(a){if(401===a.status){var n=t.get("authService"),o=s.get("authorizationData");if(o&&o.useRefreshTokens)return r.path("/refresh"),e.reject(a);n.logOut(),r.path("/login")}return e.reject(a)};return a.request=n,a.responseError=o,a}]),angular.module("app").factory("authService",["$http","$q","localStorageService","ngAuthSettings",function(e,t,r,s){var a=s.apiServiceBaseUri,n={},o={isAuth:!1,userName:"",useRefreshTokens:!1},i={provider:"",userName:"",externalAccessToken:""},u=function(t){return l(),e.post(a+"api/account/register",t).then(function(e){return e})},c=function(n){var i="grant_type=password&username="+n.userName+"&password="+n.password;n.useRefreshTokens&&(i=i+"&client_id="+s.clientId);var u=t.defer();return e.post(a+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){n.useRefreshTokens?r.set("authorizationData",{token:e.access_token,userName:n.userName,refreshToken:e.refresh_token,useRefreshTokens:!0,isAdmin:e.isAdmin}):r.set("authorizationData",{token:e.access_token,userName:n.userName,refreshToken:"",useRefreshTokens:!1,isAdmin:e.isAdmin}),o.isAuth=!0,o.userName=n.userName,o.useRefreshTokens=n.useRefreshTokens,"True"===e.isAdmin?o.isAdmin=!0:o.isAdmin=!1,u.resolve(e)}).error(function(e){l(),u.reject(e)}),u.promise},l=function(){r.remove("authorizationData"),o.isAuth=!1,o.userName="",o.useRefreshTokens=!1,o.isAdmin=!1},p=function(){var e=r.get("authorizationData");e&&(o.isAuth=!0,o.userName=e.userName,o.useRefreshTokens=e.useRefreshTokens,"True"===e.isAdmin?o.isAdmin=!0:o.isAdmin=!1)},d=function(){var n=t.defer(),o=r.get("authorizationData");if(o&&o.useRefreshTokens){var i="grant_type=refresh_token&refresh_token="+o.refreshToken+"&client_id="+s.clientId;r.remove("authorizationData"),e.post(a+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:e.refresh_token,useRefreshTokens:!0}),n.resolve(e)}).error(function(e){l(),n.reject(e)})}return n.promise},f=function(s){var n=t.defer();return e.get(a+"api/account/ObtainLocalAccessToken",{params:{provider:s.provider,externalAccessToken:s.externalAccessToken}}).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:"",useRefreshTokens:!1}),o.isAuth=!0,o.userName=e.userName,o.useRefreshTokens=!1,n.resolve(e)}).error(function(e){l(),n.reject(e)}),n.promise},h=function(s){var n=t.defer();return e.post(a+"api/account/registerexternal",s).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:"",useRefreshTokens:!1}),o.isAuth=!0,o.userName=e.userName,o.useRefreshTokens=!1,n.resolve(e)}).error(function(e){l(),n.reject(e)}),n.promise};return n.saveRegistration=u,n.login=c,n.logOut=l,n.fillAuthData=p,n.authentication=o,n.refreshToken=d,n.obtainAccessToken=f,n.externalAuthData=i,n.registerExternal=h,n}]),angular.module("app").service("enumService",["$http","baseUrl",function(e,t){this.AddressTypes=function(){return e.get(t+"api/enum/address")},this.InfoTypes=function(){return e.get(t+"api/enum/info")},this.PhoneTypes=function(){return e.get(t+"api/enum/phone")}}]),angular.module("app").factory("localeService",["localStorageService","$translate","tmhDynamicLocale",function(e,t,r){var s={language:{key:"",dateFormat:""}};return s.getLocale=function(){var t=e.get("language");t||(t="el"),s.setLocale(t)},s.setLocale=function(a){s.language.key=a,"el"===a?s.language.dateFormat="dd/MM/yyyy HH:mm":s.language.dateFormat="MM/dd/yyyy HH:mm",t.use(a),r.set(a),e.set("language",a)},s.getLocale(),s}]);